name: Update Plex Data

on:
  workflow_dispatch:  # Allows manual triggering
  schedule:
    - cron: "*/3 * * * *"  # Also runs every 3 minutes

jobs:
  update-plex-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          set -e
          pip install requests

      - name: Fetch data from Plex API
        env:
          PLEX_TOKEN: ${{ secrets.PLEX_TOKEN }}
        run: |
          set -e
          import requests
          import json
          import os

          # Plex server URL and headers
          PLEX_URL = 'http://65.21.82.220:42428'
          HEADERS = {'X-Plex-Token': os.environ['PLEX_TOKEN']}

          # Initialize data dictionaries
          data = {
              "active_sessions": [],
              "libraries": []
          }

          # Fetch active sessions
          try:
              sessions_url = f"{PLEX_URL}/status/sessions"
              sessions_response = requests.get(sessions_url, headers=HEADERS)
              sessions_response.raise_for_status()
              data["active_sessions"] = sessions_response.json().get('MediaContainer', {}).get('Video', [])
              print("Active Sessions:", data["active_sessions"])
          except requests.exceptions.RequestException as e:
              print(f"Error fetching active sessions: {e}")
              raise

          # Fetch library sections
          try:
              library_url = f"{PLEX_URL}/library/sections"
              library_response = requests.get(library_url, headers=HEADERS)
              library_response.raise_for_status()
              for library in library_response.json().get('MediaContainer', {}).get('Directory', []):
                  # Fetch each library section's items
                  section_url = f"{PLEX_URL}/library/sections/{library['key']}/all"
                  section_response = requests.get(section_url, headers=HEADERS)
                  section_response.raise_for_status()
                  data["libraries"].append({
                      "title": library['title'],
                      "type": library['type'],
                      "items": section_response.json().get('MediaContainer', {}).get('Metadata', [])
                  })
                  print(f"Library {library['title']} fetched successfully")
          except requests.exceptions.RequestException as e:
              print(f"Error fetching libraries: {e}")
              raise

          # Save to plex_data.json
          with open('plex/plex_data.json', 'w') as json_file:
              json.dump(data, json_file)
          print("Data saved to plex_data.json:", data)

      - name: Commit and push changes
        run: |
          git config --local user.email "bise@smartbusiness.me"
          git config --local user.name "tdbnz-coding"
          git add plex/plex_data.json
          git commit -m "Update Plex data from API"
          git push
